<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tykkipeli Online - Firebase</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #1a1a2e; overflow: hidden; font-family: Arial; color: white; }
        #menu { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; align-items: center; 
            justify-content: center; z-index: 1000; text-align: center;
        }
        #menu.hidden { display: none; }
        .btn { 
            background: #4CAF50; color: white; border: none; padding: 15px 30px;
            font-size: 18px; margin: 10px; cursor: pointer; border-radius: 5px;
        }
        .btn:hover { background: #45a049; }
        #qrcode { 
            background: white; padding: 20px; margin: 20px auto;
            border-radius: 10px; display: inline-block;
        }
        #roomCode {
            font-size: 36px; font-weight: bold; color: #4CAF50;
            margin: 20px; letter-spacing: 5px;
        }
        #status { color: yellow; margin: 15px; font-size: 16px; }
        canvas { display: block; background: #16213e; }
        #info { 
            position: fixed; top: 10px; right: 10px; background: rgba(15,52,96,0.9);
            padding: 8px 15px; border-radius: 5px; color: white; z-index: 100;
        }
        .player1 { color: #0f0; }
        .player2 { color: #f00; }
        input {
            padding: 15px; font-size: 24px; width: 300px; text-align: center;
            border: 2px solid #4CAF50; border-radius: 5px; margin: 10px;
            text-transform: uppercase;
        }
    </style>
</head>
<body>
    <div id="menu">
        <div>
            <h1>üéÆ Tykkipeli Online</h1>
            <p style="margin: 20px;">‚¨ÜÔ∏è‚¨áÔ∏è = Kulma | V√ÑLI/Napautus = Ammu</p>
            <div id="status">Ladataan Firebase...</div>
            
            <div id="buttons" style="display:none;">
                <button class="btn" onclick="createGame()">üì± Luo peli (QR-koodi)</button><br>
                <button class="btn" onclick="showJoin()">üî¢ Liity peliin</button>
            </div>
            
            <div id="hostScreen" style="display:none;">
                <div id="roomCode"></div>
                <div id="qrcode"></div>
                <p style="margin-top:20px;">Skannaa QR tai kirjoita koodi toisella laitteella</p>
            </div>
            
            <div id="joinScreen" style="display:none;">
                <p>Anna pelin koodi:</p>
                <input id="codeInput" type="text" placeholder="XXXX" maxlength="4">
                <br>
                <button class="btn" onclick="joinGame()">Liity</button>
            </div>
        </div>
    </div>
    <canvas id="c"></canvas>
    <div id="info"></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

const firebaseConfig = {
  apiKey: "AIzaSyA9RGFVeItwteVL9mRezHHCX5DQex_lLqA",
  authDomain: "tykkipeli-945a3.firebaseapp.com",
  databaseURL: "https://tykkipeli-945a3-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tykkipeli-945a3",
  storageBucket: "tykkipeli-945a3.firebasestorage.app",
  messagingSenderId: "176177720878",
  appId: "1:176177720878:web:eaabae515c8a141613b9bf"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const c = document.getElementById('c');
const ctx = c.getContext('2d');
c.width = innerWidth;
c.height = innerHeight;

let gameId = '';
let me = 0;
let isHost = false;
let gameRef = null;

const g = {
    p1: { x: 0, y: 0, a: -45, pow: 25 },
    p2: { x: 0, y: 0, a: -135, pow: 25 },
    ter: [], traj: [], proj: null, turn: 1, over: false, exp: null
};

window.addEventListener('load', function() {
    setStatus('Valmis! Valitse pelimuoto');
    document.getElementById('buttons').style.display = 'block';
    
    const urlParams = new URLSearchParams(location.search);
    const code = urlParams.get('join');
    if (code) {
        document.getElementById('codeInput').value = code.toUpperCase();
        showJoin();
        setTimeout(joinGame, 500);
    }
});

function setStatus(txt) {
    document.getElementById('status').textContent = txt;
}

function generateCode() {
    return Math.random().toString(36).substr(2, 4).toUpperCase();
}

window.createGame = function() {
    gameId = generateCode();
    isHost = true;
    me = 1;
    
    document.getElementById('buttons').style.display = 'none';
    document.getElementById('hostScreen').style.display = 'block';
    document.getElementById('roomCode').textContent = gameId;
    
    const url = location.origin + location.pathname + '?join=' + gameId;
    new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 200,
        height: 200
    });
    
    setStatus('Odotetaan pelaajaa...');
    
    genTerrain();
    
    gameRef = ref(db, 'games/' + gameId);
    set(gameRef, {
        terrain: g.ter,
        p1x: g.p1.x,
        p2x: g.p2.x,
        canvasWidth: c.width,
        canvasHeight: c.height,
        player2joined: false,
        turn: 1,
        timestamp: Date.now()
    });
    
    onValue(gameRef, function(snapshot) {
        const data = snapshot.val();
        if (data && data.player2joined && !document.getElementById('menu').classList.contains('hidden')) {
            setStatus('Pelaaja 2 liittyi! Aloitetaan...');
            setTimeout(startGame, 1000);
        }
        
        if (data && document.getElementById('menu').classList.contains('hidden')) {
            handleUpdate(data);
        }
    });
};

window.showJoin = function() {
    document.getElementById('buttons').style.display = 'none';
    document.getElementById('joinScreen').style.display = 'block';
    setStatus('Anna pelin koodi');
};

window.joinGame = function() {
    gameId = document.getElementById('codeInput').value.trim().toUpperCase();
    if (gameId.length !== 4) {
        alert('Virheellinen koodi!');
        return;
    }
    
    isHost = false;
    me = 2;
    
    setStatus('Liityt√§√§n peliin...');
    
    gameRef = ref(db, 'games/' + gameId);
    onValue(gameRef, function(snapshot) {
        const data = snapshot.val();
        if (!data) {
            alert('Peli√§ ei l√∂ytynyt koodilla: ' + gameId);
            return;
        }
        
        if (!data.player2joined) {
            // K√§yt√§ T√ÑSM√ÑLLEEN samat koordinaatit kuin is√§nt√§
            // EI skaalata, vaan k√§ytet√§√§n suoraan
            g.ter = data.terrain;
            g.p1.x = data.p1x;
            g.p2.x = data.p2x;
            g.p1.y = getTerH(g.p1.x);
            g.p2.y = getTerH(g.p2.x);
            
            // Aseta canvas samaan kokoon (t√§rke√§√§!)
            c.width = data.canvasWidth;
            c.height = data.canvasHeight;
            
            update(gameRef, { player2joined: true, timestamp: Date.now() });
            
            setStatus('Aloitetaan peli...');
            setTimeout(startGame, 1000);
        } else {
            handleUpdate(data);
        }
    });
};

function handleUpdate(data) {
    // Tarkista uusi kierros
    if (data.newRound && data.newRound > (g.lastRound || 0)) {
        g.lastRound = data.newRound;
        // Lataa uusi maasto
        if (!isHost) {
            g.ter = data.terrain;
            g.p1.x = data.p1x;
            g.p2.x = data.p2x;
            c.width = data.canvasWidth;
            c.height = data.canvasHeight;
            g.p1.y = getTerH(g.p1.x);
            g.p2.y = getTerH(g.p2.x);
            
            // Nollaa peli
            g.traj = [];
            g.proj = null;
            g.over = false;
            g.exp = null;
            g.turn = 1;
            
            draw();
            updateInfo('Pelaaja 1 aloittaa!');
        }
    }
    
    // P√§ivit√§ maasto jos muuttunut (kraatterit)
    if (data.terrain && data.terrain.length > 0) {
        const terrainChanged = !g.ter || g.ter.length !== data.terrain.length || 
                               JSON.stringify(g.ter) !== JSON.stringify(data.terrain);
        if (terrainChanged) {
            g.ter = data.terrain;
            g.p1.y = getTerH(g.p1.x);
            g.p2.y = getTerH(g.p2.x);
            draw();
        }
    }
    
    // P√§ivit√§ vuoro Firebase:sta
    if (data.turn !== undefined && data.turn !== g.turn) {
        g.turn = data.turn;
        updateInfo('Pelaaja ' + g.turn + ' vuoro');
    }
    
    // Lataa vastustajan laukaus
    if (data.lastShot && data.lastShot.timestamp > (g.lastShotTime || 0)) {
        g.lastShotTime = data.lastShot.timestamp;
        // Vain jos VASTUSTAJA ampui
        if (data.lastShot.shooter !== me && !g.proj) {
            g.turn = data.lastShot.p;
            g.proj = {
                x: data.lastShot.x,
                y: data.lastShot.y,
                vx: data.lastShot.vx,
                vy: data.lastShot.vy,
                trail: [{ x: data.lastShot.x, y: data.lastShot.y }],
                shooter: data.lastShot.shooter
            };
            anim();
        }
    }
    
    // P√§ivit√§ kulma
    if (data.lastAngle && data.lastAngle.p !== me) {
        if (data.lastAngle.p === 1) {
            g.p1.a = data.lastAngle.a;
        } else {
            g.p2.a = data.lastAngle.a;
        }
        draw();
    }
}

function genTerrain() {
    g.p1.x = c.width * 0.1 + Math.random() * c.width * 0.05;
    g.p2.x = c.width * 0.85 + Math.random() * c.width * 0.05;
    g.ter = [];
    const lh = c.height * 0.7;
    const rh = c.height * 0.7;
    let y = lh;
    for (let x = 0; x < c.width; x += 10) {
        let t = x < g.p1.x + 70 ? lh : x > g.p2.x - 70 ? rh : 
                c.height * 0.75 + Math.sin(x / c.width * Math.PI * 2) * c.height * 0.15;
        y += (t - y) * 0.1 + (Math.random() - 0.5) * 60;
        y = Math.max(c.height * 0.15, Math.min(c.height * 0.95, y));
        g.ter.push({ x: x, y: y });
    }
    g.p1.y = getTerH(g.p1.x);
    g.p2.y = getTerH(g.p2.x);
}

function getTerH(x) {
    const i = Math.floor(x / 10);
    if (i >= g.ter.length - 1) return g.ter[g.ter.length - 1].y;
    const t1 = g.ter[i];
    const t2 = g.ter[i + 1];
    return t1.y + (t2.y - t1.y) * ((x - t1.x) / (t2.x - t1.x));
}

function draw() {
    ctx.fillStyle = '#16213e';
    ctx.fillRect(0, 0, c.width, c.height);
    
    ctx.fillStyle = '#228b22';
    ctx.beginPath();
    ctx.moveTo(0, c.height);
    for (var i = 0; i < g.ter.length; i++) {
        ctx.lineTo(g.ter[i].x, g.ter[i].y);
    }
    ctx.lineTo(c.width, c.height);
    ctx.fill();
    
    for (var i = 0; i < g.traj.length; i++) {
        var t = g.traj[i];
        ctx.strokeStyle = t.p === 1 ? 'rgba(0,255,0,0.3)' : 'rgba(255,0,0,0.3)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (var j = 0; j < t.pts.length; j++) {
            if (j === 0) {
                ctx.moveTo(t.pts[j].x, t.pts[j].y);
            } else {
                ctx.lineTo(t.pts[j].x, t.pts[j].y);
            }
        }
        ctx.stroke();
    }
    
    if (g.proj) {
        ctx.strokeStyle = g.turn === 1 ? 'rgba(0,255,0,0.6)' : 'rgba(255,0,0,0.6)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (var i = 0; i < g.proj.trail.length; i++) {
            if (i === 0) {
                ctx.moveTo(g.proj.trail[i].x, g.proj.trail[i].y);
            } else {
                ctx.lineTo(g.proj.trail[i].x, g.proj.trail[i].y);
            }
        }
        ctx.stroke();
    }
    
    drawTank(g.p1, '#0f0');
    drawTank(g.p2, '#f00');
    
    if (g.exp) {
        const t = (Date.now() - g.exp.t) / 800;
        if (t >= 1) {
            g.exp = null;
        } else {
            const r = g.exp.r * t;
            const a = 1 - t;
            ctx.fillStyle = 'rgba(255,100,0,' + (a * 0.8) + ')';
            ctx.beginPath();
            ctx.arc(g.exp.x, g.exp.y, r, 0, Math.PI * 2);
            ctx.fill();
        }
    }
}

function drawTank(p, col) {
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.fillStyle = col;
    ctx.fillRect(-15, -10, 30, 10);
    ctx.beginPath();
    ctx.arc(0, -10, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = col;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, -10);
    const ang = p.a * Math.PI / 180;
    ctx.lineTo(Math.cos(ang) * 20, -10 + Math.sin(ang) * 20);
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(Math.round(p.a) + '¬∞', 0, -25);
    ctx.restore();
}

function shoot() {
    if (g.proj || g.over) return;
    
    // T√ÑRKE√Ñ: Tarkista ett√§ on oma vuoro
    if (g.turn !== me) {
        updateInfo('Odota vuoroasi! (Vuoro: Pelaaja ' + g.turn + ')');
        return;
    }
    
    const p = g.turn === 1 ? g.p1 : g.p2;
    const a = p.a * Math.PI / 180;
    const pow = p.pow * (0.98 + Math.random() * 0.04);
    const sy = p.y - 15;
    g.proj = { 
        x: p.x, 
        y: sy, 
        vx: Math.cos(a) * pow, 
        vy: Math.sin(a) * pow, 
        trail: [{ x: p.x, y: sy }],
        shooter: me // Merkit√§√§n kuka ampui
    };
    
    update(gameRef, {
        lastShot: { 
            p: g.turn, 
            x: p.x, 
            y: sy, 
            vx: g.proj.vx, 
            vy: g.proj.vy, 
            shooter: me, // Ampujan ID
            timestamp: Date.now() 
        },
        timestamp: Date.now()
    });
    
    anim();
}

function anim() {
    if (!g.proj) return;
    const p = g.proj;
    p.vy += 0.5;
    p.x += p.vx;
    p.y += p.vy;
    p.trail.push({ x: p.x, y: p.y });
    
    const opp = g.turn === 1 ? g.p2 : g.p1;
    const dist = Math.sqrt((p.x - opp.x) * (p.x - opp.x) + (p.y - opp.y + 10) * (p.y - opp.y + 10));
    if (dist < 18) {
        win();
        return;
    }
    if (p.x >= 0 && p.x <= c.width && p.y >= getTerH(p.x)) {
        hitGround();
        return;
    }
    if (p.x < -100 || p.x > c.width + 100 || p.y > c.height + 100) {
        miss();
        return;
    }
    
    draw();
    requestAnimationFrame(anim);
}

function hitGround() {
    const craterX = g.proj.x;
    const craterRadius = 30;
    
    // Luo kraatteri maastoon
    for (let i = 0; i < g.ter.length; i++) {
        const t = g.ter[i];
        const dist = Math.abs(t.x - craterX);
        if (dist < craterRadius) {
            const depth = (craterRadius - dist) / craterRadius * 40;
            t.y = Math.min(t.y + depth, c.height - 20);
        }
    }
    
    // P√§ivit√§ tykkien korkeudet
    g.p1.y = getTerH(g.p1.x);
    g.p2.y = getTerH(g.p2.x);
    
    g.traj.push({ p: g.turn, pts: g.proj.trail });
    const wasMyShot = g.proj.shooter === me;
    g.proj = null;
    
    // VAIN ampuja vaihtaa vuoroa ja l√§hett√§√§ p√§ivitetyn maaston
    if (wasMyShot) {
        const newTurn = g.turn === 1 ? 2 : 1;
        g.turn = newTurn;
        update(gameRef, { 
            turn: newTurn, 
            terrain: g.ter, // L√§het√§ p√§ivitetty maasto
            timestamp: Date.now() 
        });
        updateInfo('Pelaaja ' + g.turn + ' vuoro');
    }
    
    draw();
}

function miss() {
    if (g.proj) g.traj.push({ p: g.turn, pts: g.proj.trail });
    const wasMyShot = g.proj ? g.proj.shooter === me : false;
    g.proj = null;
    
    // VAIN ampuja vaihtaa vuoroa
    if (wasMyShot) {
        const newTurn = g.turn === 1 ? 2 : 1;
        g.turn = newTurn;
        update(gameRef, { turn: newTurn, timestamp: Date.now() });
        updateInfo('Pelaaja ' + g.turn + ' vuoro');
    }
    // Muut vain piirt√§v√§t
    draw();
}

function win() {
    const opp = g.turn === 1 ? g.p2 : g.p1;
    g.exp = { x: opp.x, y: opp.y - 10, r: 60, t: Date.now() };
    g.traj.push({ p: g.turn, pts: g.proj.trail });
    g.proj = null;
    
    function animExp() {
        draw();
        if (g.exp) {
            requestAnimationFrame(animExp);
        } else {
            g.over = true;
            updateInfo('Pelaaja ' + g.turn + ' VOITTI! üí•');
            setTimeout(function() {
                if (confirm('Uusi peli?')) {
                    // Tyhjenn√§ peli ja aloita uusi ilman koodia
                    if (isHost) {
                        // Is√§nt√§ generoi uuden maaston
                        g.traj = [];
                        g.proj = null;
                        g.over = false;
                        g.exp = null;
                        g.turn = 1;
                        genTerrain();
                        
                        // P√§ivit√§ Firebase uudella maastolla
                        update(gameRef, {
                            terrain: g.ter,
                            p1x: g.p1.x,
                            p2x: g.p2.x,
                            canvasWidth: c.width,
                            canvasHeight: c.height,
                            turn: 1,
                            lastShot: null,
                            lastAngle: null,
                            timestamp: Date.now(),
                            newRound: Date.now() // Merkki uudesta kierroksesta
                        });
                        
                        draw();
                        updateInfo('Pelaaja 1 aloittaa!');
                    } else {
                        // Vieras odottaa is√§nn√§n uutta maastoa
                        setStatus('Odotetaan uutta peli√§...');
                        // handleUpdate hoitaa loput
                    }
                }
            }, 2000);
        }
    }
    animExp();
}

function updateInfo(txt) {
    document.getElementById('info').innerHTML = '<span class="player' + g.turn + '">' + txt + '</span>';
}

document.addEventListener('keydown', function(e) {
    if (g.proj || g.over || g.turn !== me) return;
    const p = g.turn === 1 ? g.p1 : g.p2;
    if (e.code === 'ArrowUp') {
        e.preventDefault();
        p.a = Math.max(p.a - 1, g.turn === 1 ? -90 : -180);
        update(gameRef, { lastAngle: { p: g.turn, a: p.a }, timestamp: Date.now() });
        draw();
    } else if (e.code === 'ArrowDown') {
        e.preventDefault();
        p.a = Math.min(p.a + 1, g.turn === 1 ? 0 : -90);
        update(gameRef, { lastAngle: { p: g.turn, a: p.a }, timestamp: Date.now() });
        draw();
    } else if (e.code === 'Space') {
        e.preventDefault();
        shoot();
    }
});

let touchY = null;
let moved = false;
c.addEventListener('touchstart', function(e) {
    e.preventDefault();
    if (g.proj || g.over || g.turn !== me) return;
    touchY = e.touches[0].clientY;
    moved = false;
});

c.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (!touchY || g.proj || g.over || g.turn !== me) return;
    const dy = touchY - e.touches[0].clientY;
    if (Math.abs(dy) > 5) moved = true;
    const p = g.turn === 1 ? g.p1 : g.p2;
    p.a = Math.max(g.turn === 1 ? -90 : -180, Math.min(g.turn === 1 ? 0 : -90, p.a - dy * 0.1));
    update(gameRef, { lastAngle: { p: g.turn, a: p.a }, timestamp: Date.now() });
    touchY = e.touches[0].clientY;
    draw();
});

c.addEventListener('touchend', function(e) {
    e.preventDefault();
    if (touchY && !moved && g.turn === me) shoot();
    touchY = null;
    moved = false;
});

c.addEventListener('click', function() {
    if (g.turn === me && !g.proj && !g.over) shoot();
});

function startGame() {
    document.getElementById('menu').classList.add('hidden');
    g.turn = 1;
    g.traj = [];
    g.proj = null;
    g.over = false;
    draw();
    updateInfo('Pelaaja 1 aloittaa!');
}
</script>
</body>
</html>
