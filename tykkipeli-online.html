<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tykkipeli Online</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #1a1a2e; overflow: hidden; font-family: Arial; }
        #menu { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; align-items: center; 
            justify-content: center; z-index: 1000; color: white; text-align: center;
        }
        #menu.hidden { display: none; }
        .btn { 
            background: #4CAF50; color: white; border: none; padding: 15px 30px;
            font-size: 18px; margin: 10px; cursor: pointer; border-radius: 5px;
        }
        #linkDisplay { 
            background: rgba(255,255,255,0.1); padding: 15px; margin: 15px;
            border-radius: 5px; word-break: break-all; font-size: 12px;
            max-width: 400px;
        }
        #status {
            color: yellow;
            margin: 10px;
            font-size: 14px;
        }
        canvas { display: block; background: #16213e; }
        #info { 
            position: fixed; top: 10px; right: 10px; background: rgba(15,52,96,0.9);
            padding: 8px 15px; border-radius: 5px; color: white; z-index: 100;
        }
        .player1 { color: #0f0; }
        .player2 { color: #f00; }
    </style>
</head>
<body>
    <div id="menu">
        <div>
            <h1>üéÆ Tykkipeli Online</h1>
            <div id="status">Ladataan...</div>
            <p style="margin: 20px;">‚¨ÜÔ∏è‚¨áÔ∏è = Kulma | V√ÑLI/Napautus = Ammu</p>
            <div id="buttons" style="display:none;">
                <button class="btn" onclick="host()">Luo peli</button><br>
                <button class="btn" onclick="showJoin()">Liity</button>
            </div>
            <div id="hostWait" style="display:none;">
                <p>Jaa linkki:</p>
                <div id="linkDisplay"></div>
                <button class="btn" onclick="copyLink()">Kopioi</button>
            </div>
            <div id="joinInput" style="display:none;">
                <input id="roomId" placeholder="Room ID" style="padding:10px;font-size:16px;width:250px;"><br>
                <button class="btn" onclick="join()">Liity</button>
            </div>
        </div>
    </div>
    <canvas id="c"></canvas>
    <div id="info"></div>

<script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
<script>
// Check if PeerJS loaded
window.addEventListener('load', function() {
    if (typeof Peer === 'undefined') {
        document.getElementById('status').textContent = 'VIRHE: PeerJS ei latautunut!';
        document.getElementById('status').style.color = 'red';
        return;
    }
    
    document.getElementById('status').textContent = 'Valmis!';
    document.getElementById('status').style.color = '#0f0';
    document.getElementById('buttons').style.display = 'block';
    
    // Auto-join from URL
    const rid = new URLSearchParams(location.search).get('room');
    if (rid) { 
        document.getElementById('roomId').value = rid; 
        showJoin(); 
        setTimeout(join, 500); 
    }
});

const c = document.getElementById('c');
const ctx = c.getContext('2d');
c.width = innerWidth;
c.height = innerHeight;

let peer, conn, me = 0, isHost = false, gameStarted = false;
const g = {
    p1: { x: 0, y: 0, a: -45, pow: 25 },
    p2: { x: 0, y: 0, a: -135, pow: 25 },
    ter: [], traj: [], proj: null, turn: 1, over: false, exp: null
};

function setStatus(txt) {
    document.getElementById('status').textContent = txt;
}

function host() {
    setStatus('Luodaan huonetta...');
    document.getElementById('buttons').style.display = 'none';
    document.getElementById('hostWait').style.display = 'block';
    
    try {
        peer = new Peer();
        isHost = true;
        me = 1;
        
        peer.on('open', function(id) {
            const url = location.origin + location.pathname + '?room=' + id;
            document.getElementById('linkDisplay').textContent = url;
            setStatus('Odotetaan pelaajaa...');
        });
        
        peer.on('connection', function(connection) {
            setStatus('Pelaaja liittyi!');
            conn = connection;
            
            conn.on('data', function(data) {
                handleMessage(data);
            });
            
            conn.on('error', function(err) {
                setStatus('Virhe: ' + err);
            });
            
            // Send terrain after delay
            setTimeout(function() {
                if (!gameStarted) {
                    setStatus('Aloitetaan peli...');
                    genTerrain();
                    
                    try {
                        conn.send({
                            t: 'start',
                            ter: g.ter,
                            p1x: g.p1.x,
                            p2x: g.p2.x,
                            w: c.width,
                            h: c.height
                        });
                        startGame();
                    } catch(e) {
                        setStatus('L√§hetysvirhe: ' + e.message);
                    }
                }
            }, 800);
        });
        
        peer.on('error', function(err) {
            setStatus('Peer-virhe: ' + err.type);
        });
        
    } catch(e) {
        setStatus('Virhe: ' + e.message);
    }
}

function showJoin() {
    document.getElementById('buttons').style.display = 'none';
    document.getElementById('joinInput').style.display = 'block';
    setStatus('Anna huoneen ID');
}

function join() {
    const rid = document.getElementById('roomId').value.trim();
    if (!rid) {
        alert('Anna huoneen ID!');
        return;
    }
    
    setStatus('Yhdistet√§√§n...');
    
    try {
        peer = new Peer();
        isHost = false;
        me = 2;
        
        peer.on('open', function() {
            setStatus('Luodaan yhteytt√§...');
            conn = peer.connect(rid, { reliable: true });
            
            conn.on('open', function() {
                setStatus('Yhdistetty! Odotetaan peli√§...');
            });
            
            conn.on('data', function(data) {
                handleMessage(data);
            });
            
            conn.on('error', function(err) {
                setStatus('Yhteys ep√§onnistui: ' + err);
            });
        });
        
        peer.on('error', function(err) {
            setStatus('Virhe: ' + err.type);
            alert('Yhteys ep√§onnistui! Tarkista ID.');
        });
        
    } catch(e) {
        setStatus('Virhe: ' + e.message);
    }
}

function handleMessage(d) {
    if (d.t === 'start') {
        setStatus('Aloitetaan peli...');
        const sx = c.width / d.w;
        const sy = c.height / d.h;
        g.ter = [];
        for (var i = 0; i < d.ter.length; i++) {
            g.ter.push({ x: d.ter[i].x * sx, y: d.ter[i].y * sy });
        }
        g.p1.x = d.p1x * sx;
        g.p2.x = d.p2x * sx;
        g.p1.y = getTerH(g.p1.x);
        g.p2.y = getTerH(g.p2.x);
        startGame();
    } else if (d.t === 'shot') {
        g.turn = d.p;
        g.proj = { x: d.x, y: d.y, vx: d.vx, vy: d.vy, trail: [{ x: d.x, y: d.y }] };
        anim();
    } else if (d.t === 'ang') {
        if (d.p === 1) {
            g.p1.a = d.a;
        } else {
            g.p2.a = d.a;
        }
        draw();
    }
}

function send(d) {
    if (conn && conn.open) {
        try {
            conn.send(d);
        } catch(e) {
            setStatus('L√§hetysvirhe: ' + e.message);
        }
    }
}

function copyLink() {
    const txt = document.getElementById('linkDisplay').textContent;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(txt).then(function() {
            alert('Kopioitu!');
        });
    } else {
        // Fallback for Safari
        const el = document.createElement('textarea');
        el.value = txt;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        alert('Kopioitu!');
    }
}

function genTerrain() {
    g.p1.x = c.width * 0.1 + Math.random() * c.width * 0.05;
    g.p2.x = c.width * 0.85 + Math.random() * c.width * 0.05;
    g.ter = [];
    const lh = c.height * 0.7;
    const rh = c.height * 0.7;
    let y = lh;
    for (let x = 0; x < c.width; x += 10) {
        let t = x < g.p1.x + 70 ? lh : x > g.p2.x - 70 ? rh : 
                c.height * 0.75 + Math.sin(x / c.width * Math.PI * 2) * c.height * 0.15;
        y += (t - y) * 0.1 + (Math.random() - 0.5) * 60;
        y = Math.max(c.height * 0.15, Math.min(c.height * 0.95, y));
        g.ter.push({ x: x, y: y });
    }
    g.p1.y = getTerH(g.p1.x);
    g.p2.y = getTerH(g.p2.x);
}

function getTerH(x) {
    const i = Math.floor(x / 10);
    if (i >= g.ter.length - 1) return g.ter[g.ter.length - 1].y;
    const t1 = g.ter[i];
    const t2 = g.ter[i + 1];
    return t1.y + (t2.y - t1.y) * ((x - t1.x) / (t2.x - t1.x));
}

function draw() {
    ctx.fillStyle = '#16213e';
    ctx.fillRect(0, 0, c.width, c.height);
    
    ctx.fillStyle = '#228b22';
    ctx.beginPath();
    ctx.moveTo(0, c.height);
    for (var i = 0; i < g.ter.length; i++) {
        ctx.lineTo(g.ter[i].x, g.ter[i].y);
    }
    ctx.lineTo(c.width, c.height);
    ctx.fill();
    
    for (var i = 0; i < g.traj.length; i++) {
        var t = g.traj[i];
        ctx.strokeStyle = t.p === 1 ? 'rgba(0,255,0,0.3)' : 'rgba(255,0,0,0.3)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        for (var j = 0; j < t.pts.length; j++) {
            if (j === 0) {
                ctx.moveTo(t.pts[j].x, t.pts[j].y);
            } else {
                ctx.lineTo(t.pts[j].x, t.pts[j].y);
            }
        }
        ctx.stroke();
    }
    
    if (g.proj) {
        ctx.strokeStyle = g.turn === 1 ? 'rgba(0,255,0,0.6)' : 'rgba(255,0,0,0.6)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (var i = 0; i < g.proj.trail.length; i++) {
            if (i === 0) {
                ctx.moveTo(g.proj.trail[i].x, g.proj.trail[i].y);
            } else {
                ctx.lineTo(g.proj.trail[i].x, g.proj.trail[i].y);
            }
        }
        ctx.stroke();
    }
    
    drawTank(g.p1, '#0f0');
    drawTank(g.p2, '#f00');
    
    if (g.exp) {
        const t = (Date.now() - g.exp.t) / 800;
        if (t >= 1) {
            g.exp = null;
        } else {
            const r = g.exp.r * t;
            const a = 1 - t;
            ctx.fillStyle = 'rgba(255,100,0,' + (a * 0.8) + ')';
            ctx.beginPath();
            ctx.arc(g.exp.x, g.exp.y, r, 0, Math.PI * 2);
            ctx.fill();
        }
    }
}

function drawTank(p, col) {
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.fillStyle = col;
    ctx.fillRect(-15, -10, 30, 10);
    ctx.beginPath();
    ctx.arc(0, -10, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = col;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, -10);
    const ang = p.a * Math.PI / 180;
    ctx.lineTo(Math.cos(ang) * 20, -10 + Math.sin(ang) * 20);
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(Math.round(p.a) + '¬∞', 0, -25);
    ctx.restore();
}

function shoot() {
    if (g.proj || g.over || g.turn !== me) return;
    const p = g.turn === 1 ? g.p1 : g.p2;
    const a = p.a * Math.PI / 180;
    const pow = p.pow * (0.98 + Math.random() * 0.04);
    const sy = p.y - 15;
    g.proj = { x: p.x, y: sy, vx: Math.cos(a) * pow, vy: Math.sin(a) * pow, trail: [{ x: p.x, y: sy }] };
    send({ t: 'shot', p: g.turn, x: p.x, y: sy, vx: g.proj.vx, vy: g.proj.vy });
    anim();
}

function anim() {
    if (!g.proj) return;
    const p = g.proj;
    p.vy += 0.5;
    p.x += p.vx;
    p.y += p.vy;
    p.trail.push({ x: p.x, y: p.y });
    
    const opp = g.turn === 1 ? g.p2 : g.p1;
    const dist = Math.sqrt((p.x - opp.x) * (p.x - opp.x) + (p.y - opp.y + 10) * (p.y - opp.y + 10));
    if (dist < 18) {
        win();
        return;
    }
    if (p.x >= 0 && p.x <= c.width && p.y >= getTerH(p.x)) {
        hitGround();
        return;
    }
    if (p.x < -100 || p.x > c.width + 100 || p.y > c.height + 100) {
        miss();
        return;
    }
    
    draw();
    requestAnimationFrame(anim);
}

function hitGround() {
    g.traj.push({ p: g.turn, pts: g.proj.trail });
    g.proj = null;
    g.turn = g.turn === 1 ? 2 : 1;
    updateInfo('Pelaaja ' + g.turn);
    draw();
}

function miss() {
    if (g.proj) g.traj.push({ p: g.turn, pts: g.proj.trail });
    g.proj = null;
    g.turn = g.turn === 1 ? 2 : 1;
    updateInfo('Pelaaja ' + g.turn);
    draw();
}

function win() {
    const opp = g.turn === 1 ? g.p2 : g.p1;
    g.exp = { x: opp.x, y: opp.y - 10, r: 60, t: Date.now() };
    g.traj.push({ p: g.turn, pts: g.proj.trail });
    g.proj = null;
    
    function animExp() {
        draw();
        if (g.exp) {
            requestAnimationFrame(animExp);
        } else {
            g.over = true;
            updateInfo('Pelaaja ' + g.turn + ' VOITTI! üí•');
            setTimeout(function() {
                if (confirm('Uusi peli?')) location.reload();
            }, 2000);
        }
    }
    animExp();
}

function updateInfo(txt) {
    document.getElementById('info').innerHTML = '<span class="player' + g.turn + '">' + txt + '</span>';
}

document.addEventListener('keydown', function(e) {
    if (g.proj || g.over || g.turn !== me) return;
    const p = g.turn === 1 ? g.p1 : g.p2;
    if (e.code === 'ArrowUp') {
        e.preventDefault();
        p.a = Math.max(p.a - 1, g.turn === 1 ? -90 : -180);
        send({ t: 'ang', p: g.turn, a: p.a });
        draw();
    } else if (e.code === 'ArrowDown') {
        e.preventDefault();
        p.a = Math.min(p.a + 1, g.turn === 1 ? 0 : -90);
        send({ t: 'ang', p: g.turn, a: p.a });
        draw();
    } else if (e.code === 'Space') {
        e.preventDefault();
        shoot();
    }
});

let touchY = null;
let moved = false;
c.addEventListener('touchstart', function(e) {
    e.preventDefault();
    if (g.proj || g.over || g.turn !== me) return;
    touchY = e.touches[0].clientY;
    moved = false;
});

c.addEventListener('touchmove', function(e) {
    e.preventDefault();
    if (!touchY || g.proj || g.over || g.turn !== me) return;
    const dy = touchY - e.touches[0].clientY;
    if (Math.abs(dy) > 5) moved = true;
    const p = g.turn === 1 ? g.p1 : g.p2;
    p.a = Math.max(g.turn === 1 ? -90 : -180, Math.min(g.turn === 1 ? 0 : -90, p.a - dy * 0.1));
    send({ t: 'ang', p: g.turn, a: p.a });
    touchY = e.touches[0].clientY;
    draw();
});

c.addEventListener('touchend', function(e) {
    e.preventDefault();
    if (touchY && !moved && g.turn === me) shoot();
    touchY = null;
    moved = false;
});

c.addEventListener('click', function() {
    if (g.turn === me && !g.proj && !g.over) shoot();
});

function startGame() {
    if (gameStarted) return;
    gameStarted = true;
    document.getElementById('menu').classList.add('hidden');
    g.turn = 1;
    g.traj = [];
    g.proj = null;
    g.over = false;
    draw();
    updateInfo('Pelaaja 1 aloittaa!');
}
</script>
</body>
</html>
