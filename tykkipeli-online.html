<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tykkipeli Online</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #1a1a2e; overflow: hidden; font-family: Arial; }
        #menu { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; align-items: center; 
            justify-content: center; z-index: 1000; color: white; text-align: center;
        }
        #menu.hidden { display: none; }
        .btn { 
            background: #4CAF50; color: white; border: none; padding: 15px 30px;
            font-size: 18px; margin: 10px; cursor: pointer; border-radius: 5px;
        }
        .btn:hover { background: #45a049; }
        #linkDisplay { 
            background: rgba(255,255,255,0.1); padding: 15px; margin: 15px;
            border-radius: 5px; word-break: break-all; font-size: 14px;
        }
        canvas { display: block; background: #16213e; }
        #info { 
            position: fixed; top: 10px; right: 10px; background: rgba(15,52,96,0.9);
            padding: 8px 15px; border-radius: 5px; color: white; z-index: 100;
        }
        .player1 { color: #00ff00; }
        .player2 { color: #ff0000; }
    </style>
</head>
<body>
    <div id="menu">
        <div id="menuContent">
            <h1>üéÆ Tykkipeli Online</h1>
            <p style="margin: 20px;">‚¨ÜÔ∏è‚¨áÔ∏è = S√§√§d√§ kulma | V√ÑLILY√ñNTI/Napauta = Ammu</p>
            <div id="buttons">
                <button class="btn" onclick="host()">Luo peli</button>
                <button class="btn" onclick="showJoin()">Liity peliin</button>
            </div>
            <div id="hostWait" style="display:none;">
                <p>Jaa t√§m√§ linkki:</p>
                <div id="linkDisplay"></div>
                <button class="btn" onclick="copyLink()">Kopioi</button>
            </div>
            <div id="joinInput" style="display:none;">
                <input id="roomId" placeholder="Huoneen ID" style="padding: 10px; font-size: 16px; width: 200px;">
                <button class="btn" onclick="join()">Liity</button>
            </div>
        </div>
    </div>
    <canvas id="c"></canvas>
    <div id="info"></div>

<script>
const c = document.getElementById('c');
const ctx = c.getContext('2d');
c.width = innerWidth;
c.height = innerHeight;
addEventListener('resize', () => { c.width = innerWidth; c.height = innerHeight; draw(); });

let peer, conn, me = 0, isHost = false;
const g = {
    p1: { x: 0, y: 0, a: -45, pow: 25 },
    p2: { x: 0, y: 0, a: -135, pow: 25 },
    ter: [], traj: [], proj: null, turn: 1, over: false, exp: null
};

// URL handling
onload = () => {
    const rid = new URLSearchParams(location.search).get('room');
    if (rid) { document.getElementById('roomId').value = rid; showJoin(); setTimeout(join, 500); }
};

function host() {
    peer = new Peer();
    isHost = true;
    me = 1;
    peer.on('open', id => {
        const url = location.origin + location.pathname + '?room=' + id;
        document.getElementById('linkDisplay').textContent = url;
        document.getElementById('buttons').style.display = 'none';
        document.getElementById('hostWait').style.display = 'block';
    });
    peer.on('connection', c => {
        conn = c;
        conn.on('data', handleMsg);
        // Wait a bit then start
        setTimeout(() => {
            genTerrain();
            send({ t: 'start', ter: g.ter, p1x: g.p1.x, p2x: g.p2.x, w: c.width, h: c.height });
            startGame();
        }, 1000);
    });
}

function showJoin() {
    document.getElementById('buttons').style.display = 'none';
    document.getElementById('joinInput').style.display = 'block';
}

function join() {
    const rid = document.getElementById('roomId').value.trim();
    if (!rid) return alert('Anna ID!');
    peer = new Peer();
    isHost = false;
    me = 2;
    peer.on('open', () => {
        conn = peer.connect(rid, { reliable: true });
        conn.on('open', () => console.log('Connected'));
        conn.on('data', handleMsg);
    });
}

function handleMsg(d) {
    console.log('MSG:', d.t);
    if (d.t === 'start') {
        const sx = c.width / d.w, sy = c.height / d.h;
        g.ter = d.ter.map(p => ({ x: p.x * sx, y: p.y * sy }));
        g.p1.x = d.p1x * sx; g.p2.x = d.p2x * sx;
        g.p1.y = getTerH(g.p1.x); g.p2.y = getTerH(g.p2.x);
        startGame();
    } else if (d.t === 'shot') {
        g.turn = d.p;
        g.proj = { x: d.x, y: d.y, vx: d.vx, vy: d.vy, trail: [{ x: d.x, y: d.y }] };
        anim();
    } else if (d.t === 'ang') {
        (d.p === 1 ? g.p1 : g.p2).a = d.a;
        draw();
    }
}

function send(d) {
    if (conn && conn.open) conn.send(d);
}

function copyLink() {
    navigator.clipboard.writeText(document.getElementById('linkDisplay').textContent);
    alert('Kopioitu!');
}

function genTerrain() {
    g.p1.x = c.width * 0.1 + Math.random() * c.width * 0.05;
    g.p2.x = c.width * 0.85 + Math.random() * c.width * 0.05;
    g.ter = [];
    const lh = c.height * 0.7, rh = c.height * 0.7;
    let y = lh;
    for (let x = 0; x < c.width; x += 10) {
        let t = x < g.p1.x + 70 ? lh : x > g.p2.x - 70 ? rh : 
                c.height * 0.75 + Math.sin(x / c.width * Math.PI * 2) * c.height * 0.15;
        y += (t - y) * 0.1 + (Math.random() - 0.5) * 60;
        y = Math.max(c.height * 0.15, Math.min(c.height * 0.95, y));
        g.ter.push({ x, y });
    }
    g.p1.y = getTerH(g.p1.x);
    g.p2.y = getTerH(g.p2.x);
}

function getTerH(x) {
    const i = Math.floor(x / 10);
    if (i >= g.ter.length - 1) return g.ter[g.ter.length - 1].y;
    const t1 = g.ter[i], t2 = g.ter[i + 1];
    return t1.y + (t2.y - t1.y) * ((x - t1.x) / (t2.x - t1.x));
}

function draw() {
    ctx.fillStyle = '#16213e';
    ctx.fillRect(0, 0, c.width, c.height);
    
    // Terrain
    ctx.fillStyle = '#228b22';
    ctx.beginPath();
    ctx.moveTo(0, c.height);
    g.ter.forEach(p => ctx.lineTo(p.x, p.y));
    ctx.lineTo(c.width, c.height);
    ctx.fill();
    
    // Trails
    g.traj.forEach(t => {
        ctx.strokeStyle = t.p === 1 ? 'rgba(0,255,0,0.3)' : 'rgba(255,0,0,0.3)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        t.pts.forEach((p, i) => i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y));
        ctx.stroke();
    });
    
    // Projectile
    if (g.proj) {
        ctx.strokeStyle = g.turn === 1 ? 'rgba(0,255,0,0.6)' : 'rgba(255,0,0,0.6)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        g.proj.trail.forEach((p, i) => i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y));
        ctx.stroke();
    }
    
    // Tanks
    drawTank(g.p1, '#0f0');
    drawTank(g.p2, '#f00');
    
    // Explosion
    if (g.exp) {
        const t = (Date.now() - g.exp.t) / 800;
        if (t >= 1) g.exp = null;
        else {
            const r = g.exp.r * t, a = 1 - t;
            ctx.fillStyle = `rgba(255,100,0,${a * 0.8})`;
            ctx.beginPath();
            ctx.arc(g.exp.x, g.exp.y, r, 0, Math.PI * 2);
            ctx.fill();
        }
    }
}

function drawTank(p, col) {
    ctx.save();
    ctx.translate(p.x, p.y);
    ctx.fillStyle = col;
    ctx.fillRect(-15, -10, 30, 10);
    ctx.beginPath();
    ctx.arc(0, -10, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = col;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(0, -10);
    const ang = p.a * Math.PI / 180;
    ctx.lineTo(Math.cos(ang) * 20, -10 + Math.sin(ang) * 20);
    ctx.stroke();
    ctx.fillStyle = '#fff';
    ctx.font = '10px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(Math.round(p.a) + '¬∞', 0, -25);
    ctx.restore();
}

function shoot() {
    if (g.proj || g.over || g.turn !== me) return;
    const p = g.turn === 1 ? g.p1 : g.p2;
    const a = p.a * Math.PI / 180;
    const pow = p.pow * (0.98 + Math.random() * 0.04);
    const sy = p.y - 15;
    g.proj = { x: p.x, y: sy, vx: Math.cos(a) * pow, vy: Math.sin(a) * pow, trail: [{ x: p.x, y: sy }] };
    send({ t: 'shot', p: g.turn, x: p.x, y: sy, vx: g.proj.vx, vy: g.proj.vy });
    anim();
}

function anim() {
    if (!g.proj) return;
    const p = g.proj;
    p.vy += 0.5;
    p.x += p.vx;
    p.y += p.vy;
    p.trail.push({ x: p.x, y: p.y });
    
    const opp = g.turn === 1 ? g.p2 : g.p1;
    if (Math.sqrt((p.x - opp.x) ** 2 + (p.y - opp.y + 10) ** 2) < 18) return win();
    if (p.x >= 0 && p.x <= c.width && p.y >= getTerH(p.x)) return hitGround();
    if (p.x < -100 || p.x > c.width + 100 || p.y > c.height + 100) return miss();
    
    draw();
    requestAnimationFrame(anim);
}

function hitGround() {
    g.traj.push({ p: g.turn, pts: g.proj.trail });
    g.proj = null;
    g.turn = g.turn === 1 ? 2 : 1;
    updateInfo('Pelaaja ' + g.turn);
    draw();
}

function miss() {
    if (g.proj) g.traj.push({ p: g.turn, pts: g.proj.trail });
    g.proj = null;
    g.turn = g.turn === 1 ? 2 : 1;
    updateInfo('Pelaaja ' + g.turn);
    draw();
}

function win() {
    const opp = g.turn === 1 ? g.p2 : g.p1;
    g.exp = { x: opp.x, y: opp.y - 10, r: 60, t: Date.now() };
    g.traj.push({ p: g.turn, pts: g.proj.trail });
    g.proj = null;
    const animExp = () => {
        draw();
        if (g.exp) requestAnimationFrame(animExp);
        else {
            g.over = true;
            updateInfo('Pelaaja ' + g.turn + ' VOITTI! üí•');
            setTimeout(() => confirm('Uusi peli?') && location.reload(), 2000);
        }
    };
    animExp();
}

function updateInfo(txt) {
    document.getElementById('info').innerHTML = '<span class="player' + g.turn + '">' + txt + '</span>';
}

addEventListener('keydown', e => {
    if (g.proj || g.over || g.turn !== me) return;
    const p = g.turn === 1 ? g.p1 : g.p2;
    if (e.code === 'ArrowUp') {
        e.preventDefault();
        p.a = Math.max(p.a - 1, g.turn === 1 ? -90 : -180);
        send({ t: 'ang', p: g.turn, a: p.a });
        draw();
    } else if (e.code === 'ArrowDown') {
        e.preventDefault();
        p.a = Math.min(p.a + 1, g.turn === 1 ? 0 : -90);
        send({ t: 'ang', p: g.turn, a: p.a });
        draw();
    } else if (e.code === 'Space') {
        e.preventDefault();
        shoot();
    }
});

let touchY = null, moved = false;
c.addEventListener('touchstart', e => {
    e.preventDefault();
    if (g.proj || g.over || g.turn !== me) return;
    touchY = e.touches[0].clientY;
    moved = false;
});

c.addEventListener('touchmove', e => {
    e.preventDefault();
    if (!touchY || g.proj || g.over || g.turn !== me) return;
    const dy = touchY - e.touches[0].clientY;
    if (Math.abs(dy) > 5) moved = true;
    const p = g.turn === 1 ? g.p1 : g.p2;
    p.a = Math.max(g.turn === 1 ? -90 : -180, Math.min(g.turn === 1 ? 0 : -90, p.a - dy * 0.1));
    send({ t: 'ang', p: g.turn, a: p.a });
    touchY = e.touches[0].clientY;
    draw();
});

c.addEventListener('touchend', e => {
    e.preventDefault();
    if (touchY && !moved && g.turn === me) shoot();
    touchY = null;
    moved = false;
});

c.addEventListener('click', () => {
    if (g.turn === me && !g.proj && !g.over) shoot();
});

function startGame() {
    document.getElementById('menu').classList.add('hidden');
    g.turn = 1;
    g.traj = [];
    g.proj = null;
    g.over = false;
    draw();
    updateInfo('Pelaaja 1 aloittaa!');
}
</script>
</body>
</html>
